name: Deployment Status Workflow

on:
  push:
    branches: [main]

jobs:
  pre-deployment:
    name: pre-deployment
    runs-on: ubuntu-latest
    outputs:
      issue-number: ${{ steps.create-issue.outputs.issue-number }}
      previous-commit-sha: ${{ steps.get-previous-commit.outputs.sha }}
      package-version: ${{ steps.get-package-version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run lint checks
        run: npm run lint

      - name: Run tests
        run: npm run test:coverage

      - name: Get previous commit SHA
        id: get-previous-commit
        run: echo "sha=$(git rev-parse HEAD^1)" >> $GITHUB_OUTPUT

      - name: Get package version
        id: get-package-version
        run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

      - name: Create deployment tracking issue
        id: create-issue
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Deployment Tracking - ${context.sha}`,
              body: `## Deployment Tracking Information\n\n**Commit SHA:** ${context.sha}\n**Branch:** ${context.ref}\n**Triggered by:** ${context.actor}\n**Package Version:** ${{ steps.get-package-version.outputs.version }}\n**Previous Commit:** ${{ steps.get-previous-commit.outputs.sha }}\n\n### Deployment Status\n- [x] Pre-deployment checks initiated\n- [ ] Rollback preparation\n- [ ] Post-deployment completion\n\n### Build Information\n- **Node Version:** ${process.version}\n- **Workflow:** ${context.workflow}\n- **Run ID:** ${context.runId}\n\n---\n*This issue tracks the deployment process and provides rollback information.*`,
              labels: ['deployment', 'in-progress']
            });
            core.setOutput('issue-number', issue.data.number);

      - name: Post pre-deployment comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.create-issue.outputs.issue-number }},
              body: '### âœ… Pre-deployment checks completed\n\nAll quality checks (lint and test) have passed successfully. The deployment tracking issue has been created and the process is moving to rollback preparation phase.'
            });

  rollback-preparation:
    name: rollback-preparation
    runs-on: ubuntu-latest
    needs: pre-deployment
    outputs:
      artifact-name: ${{ steps.create-artifacts.outputs.artifact-name }}
      checksum: ${{ steps.create-artifacts.outputs.checksum }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Create rollback artifacts directory
        run: mkdir -p rollback-artifacts

      - name: Create executable rollback script
        run: |
          cat > rollback-artifacts/rollback.sh << 'EOF'
          #!/bin/bash
          
          # Rollback Script for Deployment
          # Generated by Deployment Status Workflow
          
          set -e
          
          echo "ğŸ”„ Starting rollback process..."
          
          # Configuration
          PREVIOUS_COMMIT="${1:-${{ needs.pre-deployment.outputs.previous-commit-sha }}}"
          CURRENT_COMMIT="${{ github.sha }}"
          PACKAGE_VERSION="${{ needs.pre-deployment.outputs.package-version }}"
          
          echo "Rollback Configuration:"
          echo "  Previous Commit: $PREVIOUS_COMMIT"
          echo "  Current Commit: $CURRENT_COMMIT"
          echo "  Package Version: $PACKAGE_VERSION"
          echo ""
          
          # Check if git is available
          if ! command -v git &> /dev/null; then
              echo "âŒ Error: git is not available"
              exit 1
          fi
          
          # Check if we're in a git repository
          if ! git rev-parse --git-dir > /dev/null 2>&1; then
              echo "âŒ Error: not in a git repository"
              exit 1
          fi
          
          # Check if the previous commit exists
          if ! git cat-file -t "$PREVIOUS_COMMIT" > /dev/null 2>&1; then
              echo "âŒ Error: previous commit $PREVIOUS_COMMIT not found"
              exit 1
          fi
          
          echo "âœ… Pre-rollback checks passed"
          echo ""
          
          # Create backup of current state
          echo "ğŸ“¦ Creating backup of current state..."
          git stash push -m "rollback-backup-$(date +%Y%m%d-%H%M%S)"
          
          # Reset to previous commit
          echo "ğŸ”„ Resetting to previous commit: $PREVIOUS_COMMIT"
          git reset --hard "$PREVIOUS_COMMIT"
          
          # Restore dependencies
          echo "ğŸ“¦ Restoring dependencies..."
          if [ -f "package.json" ]; then
              npm ci
          fi
          
          echo "âœ… Rollback completed successfully!"
          echo ""
          echo "ğŸ“‹ Rollback Summary:"
          echo "  - Reset to commit: $PREVIOUS_COMMIT"
          echo "  - Package version: $PACKAGE_VERSION"
          echo "  - Backup created: true"
          echo ""
          echo "ğŸ’¡ To undo this rollback, run: git stash pop"
          EOF
          
          chmod +x rollback-artifacts/rollback.sh

      - name: Create configuration backups
        run: |
          # Backup package.json
          cp package.json rollback-artifacts/package.json.backup
          cp package-lock.json rollback-artifacts/package-lock.json.backup
          
          # Create environment template
          cat > rollback-artifacts/.env.template << 'EOF'
          # Environment Configuration Template
          # Generated by Deployment Status Workflow
          
          # Application Settings
          NODE_ENV=development
          PORT=3000
          
          # Database Configuration (if needed)
          # DB_HOST=localhost
          # DB_PORT=5432
          # DB_NAME=your_database
          # DB_USER=your_user
          # DB_PASSWORD=your_password
          
          # API Configuration
          # API_BASE_URL=http://localhost:3000
          # API_KEY=your_api_key
          
          # Logging
          LOG_LEVEL=info
          LOG_FILE=logs/app.log
          EOF

      - name: Create dependency verification script
        run: |
          cat > rollback-artifacts/verify-dependencies.js << 'EOF'
          #!/usr/bin/env node
          
          // Dependency Verification Script
          // Generated by Deployment Status Workflow
          
          const fs = require('fs');
          const path = require('path');
          
          console.log('ğŸ” Verifying dependencies...');
          
          // Check package.json
          if (!fs.existsSync('package.json')) {
              console.error('âŒ package.json not found');
              process.exit(1);
          }
          
          const packageJson = JSON.parse(fs.readFileSync('package.json', 'utf8'));
          console.log('âœ… package.json found and valid');
          
          // Check dependencies
          const dependencies = { ...packageJson.dependencies, ...packageJson.devDependencies };
          const depCount = Object.keys(dependencies).length;
          console.log(`ğŸ“¦ Found ${depCount} dependencies`);
          
          // Check node_modules
          if (!fs.existsSync('node_modules')) {
              console.log('âš ï¸  node_modules not found - run npm install');
          } else {
              console.log('âœ… node_modules exists');
          }
          
          // Check critical files
          const criticalFiles = [
              'src/app.js',
              'package.json',
              'package-lock.json'
          ];
          
          criticalFiles.forEach(file => {
              if (fs.existsSync(file)) {
                  console.log(`âœ… ${file} exists`);
              } else {
                  console.log(`âš ï¸  ${file} not found`);
              }
          });
          
          console.log('\nğŸ“‹ Dependency verification completed');
          console.log('ğŸ’¡ Run "npm install" to install missing dependencies');
          EOF
          
          chmod +x rollback-artifacts/verify-dependencies.js

      - name: Create rollback documentation
        run: |
          cat > rollback-artifacts/ROLLBACK.md << 'EOF'
          # Rollback Documentation
          
          ## Overview
          This rollback package provides everything needed to safely revert the deployment to the previous state.
          
          ## Quick Rollback
          
          ### Method 1: Using the Automated Script
          \`\`\`bash
          ./rollback.sh
          \`\`\`
          
          ### Method 2: Manual Rollback
          \`\`\`bash
          # Reset to previous commit
          git reset --hard ${{ needs.pre-deployment.outputs.previous-commit-sha }}
          
          # Restore dependencies
          npm ci
          
          # Restart application
          npm start
          \`\`\`
          
          ## Rollback Components
          
          ### 1. Rollback Script (\`rollback.sh\`)
          - Automated rollback with error handling
          - Pre-rollback validation checks
          - Backup creation before rollback
          - Dependency restoration
          
          ### 2. Configuration Backups
          - \`package.json.backup\` - Original package configuration
          - \`package-lock.json.backup\` - Original lock file
          - \`.env.template\` - Environment configuration template
          
          ### 3. Dependency Verification (\`verify-dependencies.js\`)
          - Validates package.json structure
          - Checks for critical files
          - Provides dependency status report
          
          ## Rollback Verification
          
          After rollback, verify the deployment:
          
          \`\`\`bash
          # Check current commit
          git rev-parse HEAD
          
          # Verify package version
          node -p "require('./package.json').version"
          
          # Run tests
          npm test
          
          # Start application
          npm start
          \`\`\`
          
          ## Troubleshooting
          
          ### Common Issues
          
          1. **Dependency Issues**
             - Run \`npm ci\` to restore dependencies
             - Check \`node -v\` for Node.js version compatibility
             
          2. **Git Issues**
             - Ensure you have write access to the repository
             - Check for uncommitted changes with \`git status\`
             
          3. **Environment Issues**
             - Copy \`.env.template\` to \`.env\` and configure
             - Check environment variables
             
          ### Support
          If you encounter issues during rollback:
          1. Check the logs above
          2. Verify all prerequisites are met
          3. Contact the deployment team
          
          ---
          *Generated by Deployment Status Workflow*
          *Commit: ${{ github.sha }}*
          *Previous Commit: ${{ needs.pre-deployment.outputs.previous-commit-sha }}*
          *Package Version: ${{ needs.pre-deployment.outputs.package-version }}*
          EOF

      - name: Create compressed rollback package
        id: create-artifacts
        run: |
          cd rollback-artifacts
          tar -czf rollback-package-${{ github.sha }}.tar.gz *
          
          # Calculate SHA256 checksum
          CHECKSUM=$(sha256sum rollback-package-${{ github.sha }}.tar.gz | cut -d' ' -f1)
          echo "checksum=$CHECKSUM" >> $GITHUB_OUTPUT
          echo "artifact-name=rollback-package-${{ github.sha }}.tar.gz" >> $GITHUB_OUTPUT
          
          # Create checksum file
          echo "$CHECKSUM  rollback-package-${{ github.sha }}.tar.gz" > checksums.txt
          
          cd ..

      - name: Upload rollback artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rollback-package-${{ github.sha }}
          path: rollback-artifacts/
          retention-days: 30

      - name: Post rollback preparation comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.pre-deployment.outputs.issue-number }},
              body: `### ğŸ”„ Rollback Plan Ready\n\n**Previous Commit:** ${{ needs.pre-deployment.outputs.previous-commit-sha }}\n**Current Commit:** ${{ github.sha }}\n**Package Version:** ${{ needs.pre-deployment.outputs.package-version }}\n**Artifact:** rollback-package-${{ github.sha }}\n\n### âœ… Rollback Components Completed\n\nâœ… Executable rollback script with error handling\nâœ… Configuration backups (package.json, package-lock.json, environment templates)\nâœ… Dependency verification script for compatibility checking\nâœ… Detailed rollback documentation with step-by-step instructions\nâœ… Compressed rollback package with SHA256 checksums\n\n### ğŸš€ Quick Rollback Command\n\n\`\`\`bash\n# Download and extract rollback package\nwget https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}/artifacts/${{ steps.create-artifacts.outputs.artifact-name }}\ntar -xzf rollback-package-${{ github.sha }}.tar.gz\n\n# Execute rollback\n./rollback.sh\n\`\`\`\n\n### ğŸ” Verification Status\n\n**Rollback script created:** true\n**Configuration backup:** true\n**Artifact checksum:** SHA256: ${{ steps.create-artifacts.outputs.checksum }}\n\n### ğŸ“‹ Next Steps\n\nThe rollback preparation is complete. The deployment can now proceed to the post-deployment phase.`
            });

  post-deployment:
    name: post-deployment
    runs-on: ubuntu-latest
    needs: [pre-deployment, rollback-preparation]
    steps:
      - name: Update deployment issue labels
        uses: actions/github-script@v7
        with:
          script: |
            // Remove 'in-progress' label
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: ${{ needs.pre-deployment.outputs.issue-number }},
                name: 'in-progress'
              });
            } catch (error) {
              // Label might not exist, ignore error
              console.log('in-progress label not found or already removed');
            }
            
            // Add 'completed' label
            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: ${{ needs.pre-deployment.outputs.issue-number }},
                labels: ['completed']
              });
            } catch (error) {
              console.log('Error adding completed label:', error.message);
            }

      - name: Post final deployment comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.pre-deployment.outputs.issue-number }},
              body: `### âœ… Deployment Completed Successfully\n\nThe deployment has been completed successfully! Here are the details:\n\n### ğŸ“Š Deployment Summary\n\n- **Commit:** ${{ github.sha }}\n- **Previous Commit:** ${{ needs.pre-deployment.outputs.previous-commit-sha }}\n- **Package Version:** ${{ needs.pre-deployment.outputs.package-version }}\n- **Workflow Run:** [View Run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n\n### ğŸ”„ Rollback Information\n\n**Rollback Artifact:** rollback-package-${{ github.sha }}\n**Artifact Retention:** 30 days\n**Checksum:** SHA256: ${{ needs.rollback-preparation.outputs.checksum }}\n\n### ğŸ“¥ Download Rollback Package\n\nThe rollback package is available for download from the workflow artifacts:\n\n1. Go to the [workflow run page](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n2. Click on the "rollback-package-${{ github.sha }}" artifact\n3. Download and extract the package\n4. Follow the instructions in ROLLBACK.md\n\n### ğŸ¯ Deployment Status\n\n- [x] Pre-deployment checks âœ…\n- [x] Rollback preparation âœ…\n- [x] Post-deployment completion âœ…\n\n---\n*This deployment is now complete and monitored. Use the rollback package if issues arise.*`
            });

      - name: Close deployment tracking issue
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.pre-deployment.outputs.issue-number }},
              state: 'closed'
            });